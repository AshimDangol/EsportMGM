rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the requesting user is a Tournament Organizer.
    function isTournamentOrganizer(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role == 'tournament_organizer';
    }

    // Helper function to check if the requesting user is a Clan Leader.
    function isClanLeader(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role == 'clan_leader';
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // Any authenticated user can read, create, and update their own user document.
      allow read, create, update: if request.auth != null;
      // No user can delete their own account.
      allow delete: if false;
    }

    // Rules for 'announcements'
    match /announcements/{announcementId} {
      // Any authenticated user can read, create, update, and delete announcements.
      allow read, write: if request.auth != null;
    }

    // Rules for 'players' and 'teams'
    match /players/{playerId} {
      allow read, write: if request.auth != null;
    }

    match /teams/{teamId} {
      allow read, write: if request.auth != null;
    }

    // Rules for 'clans'
    match /clans/{clanId} {
      allow read, create, update: if request.auth != null;
      // Only a Clan Leader can delete a clan.
      allow delete: if isClanLeader(request.auth.uid);
    }

    // Rules for 'tournaments'
    match /tournaments/{tournamentId} {
      allow read, create, update: if request.auth != null;
      // Only a Tournament Organizer can delete a tournament.
      allow delete: if isTournamentOrganizer(request.auth.uid);
    }

    // Rules for 'matches'
    match /matches/{matchId} {
      allow read: if request.auth != null;
      // Only Tournament Organizers can create, update, or delete matches.
      allow write: if isTournamentOrganizer(request.auth.uid);
    }

    // General collections are open to all authenticated users.
    // Consider adding more specific rules if your app requires them.
    match /{collection}/{docId} {
      allow read, write: if request.auth != null;
    }
  }
}
